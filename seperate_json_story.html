<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Story</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
            color: #333;
        }
        .content {
            margin: 20px;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            font-size: larger;
            text-align: center;
        }
        .button {
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            padding: 10px 20px;
            margin: 10px 5px;
            cursor: pointer;
            border-radius: 5px;
            display: inline-block;
            font-size: large;
        }
        .button:hover {
            background-color: #e0e0e0;
        }
        .button.disabled {
            background-color: #ddd;
            cursor: not-allowed;
        }
        h1 {
            font-size: 3rem;
            margin-bottom: 20px;
            text-align: center;
        }
        h2 {
            font-size: 1.5rem;
            margin-top: 50px;
            text-align: center;
        }
        .options {
            margin-top: 20px;
        }
        #buttonContainer {
            margin: 20px;
            display: flex;
            justify-content: space-between;
        }
    </style>
</head>
<body>
    <div id="buttonContainer">
        <div id="backButtonContainer"></div> <!-- Container for the back button -->
        <div id="nextButtonContainer"></div> <!-- Container for the next button -->
    </div>
    <div class="content" id="storyContent"></div>

    <script>
        // Fetch the story JSON data
        fetch('storyData.json')
            .then(response => response.json())
            .then(storyData => {
                let history = []; // Store the page history
                let currentPageId = storyData.data.initial; // Track current page
                let nextPage = null; // Keep track of the next page after back press
                let optionSelected = false; // Track if any option has been selected

                // Function to render a specific page dynamically
                function renderPage(pageId) {
                    currentPageId = pageId; // Update current page ID
                    const page = storyData.data.stitches[pageId];
                    const contentDiv = document.getElementById('storyContent');
                    const isInitialPage = pageId === storyData.data.initial;

                    // Clear existing content
                    contentDiv.innerHTML = '';

                    // Add the story title only if it's the first page
                    if (isInitialPage) {
                        contentDiv.innerHTML += `<h1>${storyData.title}</h1>`;
                    }

                    // Add page label
                    const pageLabel = page.content.find(item => item.pageLabel)?.pageLabel;
                    if (pageLabel) {
                        contentDiv.innerHTML += `<h2>${pageLabel}</h2>`;
                    }

                    // Add main story text
                    const mainText = page.content.filter(item => typeof item === 'string');
                    mainText.forEach(text => {
                        contentDiv.innerHTML += `<p>${text}</p>`;
                    });

                    // Render available options
                    const optionsDiv = document.createElement('div');
                    optionsDiv.classList.add('options');
                    page.content.forEach(item => {
                        if (item.option) {
                            const button = document.createElement('button');
                            button.classList.add('button');
                            button.textContent = item.option;

                            if (item.linkPath) {
                                // If there's a linkPath, go to that page
                                button.onclick = () => {
                                    history.push(pageId); // Save current page in history
                                    optionSelected = true; // Mark that an option was selected
                                    nextPage = item.linkPath; // Store the next page link
                                    renderPage(item.linkPath); // Navigate to the new page
                                };
                            } else {
                                // If no linkPath (null), just show a message or disable button
                                button.onclick = () => alert("No further action available.");
                            }

                            optionsDiv.appendChild(button);
                        }
                    });

                    // Append options if they exist
                    if (optionsDiv.children.length > 0) {
                        contentDiv.appendChild(optionsDiv);
                    } else {
                        contentDiv.innerHTML += `<p>The story ends here. Thank you for reading!</p>`;
                    }

                    // Add the Back button outside the content box, in a different container
                    const backButtonContainer = document.getElementById('backButtonContainer');
                    backButtonContainer.innerHTML = ''; // Clear any previous back button
                    const backButton = document.createElement('button');
                    backButton.classList.add('button');
                    if (history.length > 0 && !isInitialPage) {
                        backButton.textContent = "Back";
                        backButton.onclick = () => {
                            const previousPage = history.pop(); // Get the last page
                            optionSelected = false; // Reset the option selected flag
                            nextPage = null; // Clear the next page link
                            renderPage(previousPage); // Render the previous page
                        };
                        backButton.classList.remove('disabled');
                        backButton.disabled = false; // Enable the back button
                    } else {
                        backButton.textContent = "Back";
                        backButton.classList.add('button', 'disabled');
                        backButton.disabled = true; // Disable back button if on the initial page
                    }
                    backButtonContainer.appendChild(backButton);

                    // Add the Next button (enabled only after going back)
                    const nextButtonContainer = document.getElementById('nextButtonContainer');
                    nextButtonContainer.innerHTML = ''; // Clear any previous next button
                    const nextButton = document.createElement('button');
                    nextButton.classList.add('button');
                    nextButton.textContent = "Next";

                    // Enable the Next Button only after pressing Back
                    if (history.length > 0 && optionSelected) {
                        nextButton.disabled = false;
                        nextButton.classList.remove('disabled');
                        nextButton.onclick = () => {
                            renderPage(nextPage); // Go to the previously selected page
                            nextPage = null; // Reset the nextPage to null after navigation
                            optionSelected = false; // Reset the flag
                        };
                    } else {
                        nextButton.disabled = true; // Keep Next button disabled by default
                        nextButton.classList.add('disabled');
                    }
                    nextButtonContainer.appendChild(nextButton);
                }

                // Render the initial page
                renderPage(storyData.data.initial);
            })
            .catch(error => {
                console.error('Error loading the story data:', error);
            });
    </script>
</body>
</html>
